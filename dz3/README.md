# Архитектура системы Make cats free again

## Микросервисная архитектура (MSA)

### Сервисы и их обоснование
| Сервис                          | Причина вынесения                                                    |
|----------------------------------|----------------------------------------------------------------------|
| **Расчет выплат и зарплат**      | Комплаенс                                                            |
| **Регистрация и аттестация**     | Консерн топ-менеджмента: быстрый релизный цикл                       |
| **Матчинг воркеров**             | Требование [US-300]                                                  |
| **Планирование визитов**         | Scalability и Agility: необходимость гибкого масштабирования         |
| **Контроль качества**            | Разделение доменов: независимый анализ результатов работы(от сборки) |
| **Сборка расходников**           | Разделение доменов: изолированная сборка(от контроля качества)       |

![Screenshot 2025-02-04 at 12.21.02.png](Screenshot%202025-02-04%20at%2012.21.02.png)

---

## Архитектурные стили сервисов

### Микросервисы
| Сервис                          | Стиль               | Обоснование                                                                 |
|----------------------------------|---------------------|-----------------------------------------------------------------------------|
| Регистрация и аттестация         | **Microkernel**     | Гибкое конфигурирование тестов через плагины                                |
| Матчинг воркеров                | **Pipeline**        | Последовательная обработка шагов подбора ([US-300])                         |
| Остальные сервисы                | **Layered Monolith**| Простота разработки для нефункциональных требований                         |

---

## Выбор баз данных

| Сервис                          | Тип БД         |
|----------------------------------|-----------------|
| Контроль качества               | Реляционная (SQL) |
| Планирование визитов            | Реляционная (SQL) |
| Сборка расходников              | Реляционная (SQL) |
| Регистрация и аттестация        | Реляционная (SQL) |
| Матчинг воркеров                | Графовая       |
| Расчет ЗП                       | Реляционная (SQL) |

---

# ADR-001: Выбор микросервисной архитектуры для системы Make cats free again

**Status**: Accepted  
**Author**: Я  
**Date**: 04.02.2025  
**Approved by**: Я  
**Last Updated**: 04.02.2025  

---

## Context

### Бизнес-требования и ограничения
1. **Низкий Time-to-Market (TTM)**:  
   Требуется быстрое внедрение новых гипотез по отсеву котов и изменению процессов ([US-090], [US-100]).
2. **Комплаенс и безопасность**:  
   - Финансовые операции должны быть изолированы ([US-030], [US-210]).  
   - Соблюдение CatFinCompliance для хранения данных.  
3. **Масштабируемость**:  
   Ожидается рост нагрузки до 10 заказов в минуту (консёрн менеджеров).  
4. **Уникальные требования к матчингу**:  
   Алгоритм матчинга должен поддерживать конвейерную обработку ([US-300], [US-302]).  

### Консёрны стейкхолдеров
| Группа               | Консёрны                                                                 |
|-----------------------|--------------------------------------------------------------------------|
| **Топ-менеджмент**    | - Продажа скоринга воркеров как отдельного продукта                     |
| **Финотдел**          | - Ежемесячное списание средств вместо еженедельного                     |
| **Разработчики**      | - Простота отладки и мониторинга                                        |
| **Юристы**            | - Соответствие правовым нормам (например, [US-262])                     |

---

## Decision

### Архитектурные решения
1. **Микросервисная архитектура**:  
   - **Причины**:  
     - Изоляция финансовых операций для соблюдения комплаенса ([US-030], [US-210]).  
     - Возможность независимого масштабирования сервисов (например, матчинг и планирование визитов).  
     - Гибкость для реализации конвейерного матчинга ([US-300]).  

2. **Сервисы и их обоснование**:  

| Сервис                          | Причина вынесения                                                    |
|----------------------------------|----------------------------------------------------------------------|
| **Расчет выплат и зарплат**      | Комплаенс                                                            |
| **Регистрация и аттестация**     | Консерн топ-менеджмента: быстрый релизный цикл                       |
| **Матчинг воркеров**             | Требование [US-300]                                                  |
| **Планирование визитов**         | Scalability и Agility: необходимость гибкого масштабирования         |
| **Контроль качества**            | Разделение доменов: независимый анализ результатов работы(от сборки) |
| **Сборка расходников**           | Разделение доменов: изолированная сборка(от контроля качества)       |

---

## Consequences

### Положительные эффекты
- **Гибкость**: Возможность изменять логику матчинга без влияния на другие сервисы ([US-300]).  
- **Безопасность**: Изоляция финансовых данных снижает риски нарваться на закон.  
- **Масштабируемость**: Сервисы можно масштабировать независимо при росте нагрузки.  

### Отрицательные эффекты
- **Сложность управления**:  
  - Необходимость синхронизации данных между сервисами (например, обновление статусов заказов).  
  - Увеличение затрат на мониторинг.

---

## Compliance
- **Проверка вручную**:  
  - Соответствие CatFinCompliance будет проверяться через аудит кода и документации.

---

## Alternatives Considered

### Альтернатива 1: Монолитная архитектура
- **Плюсы**:  
  - Простота разработки для малых нагрузок.  
- **Минусы**:  
  - Невозможность изолировать финансовые операции.  
  - Сложность внедрения конвейерного матчинга.  

### Альтернатива 2: Service-Based Архитектура
- **Плюсы**:  
  - Общая база данных упрощает развертывание
- **Минусы**:  
  - Риск нарушения комплаенса из-за shared data. 
  - Сложность проведения миграций на одной базе

**Выбор**: Микросервисы обеспечивают лучшую изоляцию и гибкость.  

